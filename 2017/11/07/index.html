<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android,Gradle,aar,provided," />





  <link rel="alternate" href="/atom.xml" title="Just Be Unreserved!" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="首先得声明一下，其实 provided aar 这样的需求场景非常少。在 com.android.library 里可以直接 provided aar，因此这样的需求只会在 com.android.application 里存在。同时还得再声明一下，这里说的 provided 一个 aar，是只引用 aar 里的类，而 aar 里的资源还是没办法引用的。
而完成插件化之后的微店，就恰恰对这样的需求">
<meta property="og:type" content="article">
<meta property="og:title" content="在 Android Application 里 provided aar">
<meta property="og:url" content="http://liangzhitao.github.io/2017/11/07/index.html">
<meta property="og:site_name" content="Just Be Unreserved!">
<meta property="og:description" content="首先得声明一下，其实 provided aar 这样的需求场景非常少。在 com.android.library 里可以直接 provided aar，因此这样的需求只会在 com.android.application 里存在。同时还得再声明一下，这里说的 provided 一个 aar，是只引用 aar 里的类，而 aar 里的资源还是没办法引用的。
而完成插件化之后的微店，就恰恰对这样的需求">
<meta property="og:image" content="http://7x2wvb.com1.z0.glb.clouddn.com/20171112-111644@2x.png">
<meta property="og:updated_time" content="2017-11-15T15:54:23.274Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="在 Android Application 里 provided aar">
<meta name="twitter:description" content="首先得声明一下，其实 provided aar 这样的需求场景非常少。在 com.android.library 里可以直接 provided aar，因此这样的需求只会在 com.android.application 里存在。同时还得再声明一下，这里说的 provided 一个 aar，是只引用 aar 里的类，而 aar 里的资源还是没办法引用的。
而完成插件化之后的微店，就恰恰对这样的需求">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 在 Android Application 里 provided aar | Just Be Unreserved! </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Just Be Unreserved!</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">学无止境。</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                在 Android Application 里 provided aar
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-11-07T21:44:18+08:00" content="Nov 7 2017">
              Nov 7 2017
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/11/07/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/11/07/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
              &nbsp; | &nbsp;
              <span class="page-pv"><i class="fa fa-file-o"></i>
              <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
              </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>首先得声明一下，其实 <code>provided aar</code> 这样的需求场景非常少。在 <code>com.android.library</code> 里可以直接 <code>provided aar</code>，因此这样的需求只会在 <code>com.android.application</code> 里存在。同时还得再声明一下，这里说的 <code>provided</code> 一个 <code>aar</code>，是只引用 <code>aar</code> 里的类，而 <code>aar</code> 里的资源还是没办法引用的。</p>
<p>而完成插件化之后的微店，就恰恰对这样的需求非常强烈。一个 <code>application module</code> 里 <code>compile</code> 了一个<code>aar</code>，在其他 <code>application moduel</code> 里也想用这个 <code>aar</code> 里的类，而作者在发布 <code>aar</code> 的时候，并没有发布对应的 <code>jar</code>，这时候我们的做法往往是手动地解压出来 <code>aar</code> 里的 <code>classes.jar</code>，然后再在 <code>dependencies</code> 里添加这个 <code>classes.jar</code> 的 <code>provided</code> 依赖。看上去很简单嘛，可问题是遇到一个就要这样做一次，这就好麻烦了。那么有没有一种纯自动的方式去做这个事情呢？这篇文章讲的就是这个事情。<a id="more"></a></p>
<h3 id="需要解决的问题"><a href="#需要解决的问题" class="headerlink" title="需要解决的问题"></a>需要解决的问题</h3><p>首先，我们有必要把这个问题给拆解一下，看上去貌似只是一个解压一个 <code>aar</code>（其实就是一个 zip 压缩包），然后拿到其中一个叫 <code>classes.jar</code> 的 <code>entry</code>。可真要将其完全融入整个项目构建，做成完全自动化的一个过程，其中可能遇到的难点可能远超你我的想象。</p>
<ol>
<li>直接 <code>provided</code> 一个 <code>aar</code>，在编译过程中是一定会抛出 <code>provided dependencies can only be jars</code> 这样的异常的，那我们该<strong>如何添加</strong>这样一个依赖？</li>
<li>Gradle 是有离线编译功能的，如果本地缓存里已经有了这个依赖，那么开启离线编译模式，一样可以进行编译，我们 <code>provided aar</code> 怎么做到<strong>离线编译</strong>呢？</li>
<li>上一个步骤里，我们说了要能够从本地缓存取依赖，那么都有<strong>哪些本地缓存</strong>呢？</li>
<li>如果不是离线编译，本地缓存没有这个依赖，需要从远程仓库下载这个依赖，我们又该<strong>怎么下载</strong>这个远程依赖呢？</li>
<li>与步骤3类似的问题，上一步骤里我们说要从远程仓库下载这个依赖，那么我们怎么知道从<strong>哪些远程仓库</strong>下载依赖呢？</li>
<li>我们需要将整个过程完美地嵌入到构建之中，那么应该<strong>怎样嵌入</strong>到构建过程中的<strong>哪些步骤</strong>之间呢？</li>
<li>如何实现自动化从 <code>aar</code> 里取到 <code>jar</code>，同时又将 <code>jar</code> 添加到依赖里去呢？</li>
</ol>
<p>这样分析下来，你会发现如果不是对 Android 构建有比较深入的了解，每一个问题都不是那么容易就能搞的定的。而实际上，真正把所有的问题都解决掉，只需要不到 150 行代码。下面，我们就一步步去解决这些问题。</p>
<h3 id="自定义-Android-Dependency-Scope"><a href="#自定义-Android-Dependency-Scope" class="headerlink" title="自定义 Android Dependency Scope"></a>自定义 Android Dependency Scope</h3><p>我们经常看到 <code>provided</code> <code>compile</code> <code>apt</code> <code>annotationProcessor</code> 这样的字符串，这其实就是 <code>Dependency Scope</code>，也是 Gradle 项目的 <code>configuration</code>，我们通过调用如下的 api，就可以获取这个 <code>configuration</code> 包含哪些依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project.configurations.getByName(<span class="string">'provided'</span>).dependencies <span class="comment">// provided/compile/apt...</span></span><br></pre></td></tr></table></figure>
<p>我们既然要实现 <code>providedAar</code>，现有的 <code>Dependency Scope</code> 都不满足我们的需求，那就需要像 <code>apt</code> 那样去自定义一个 <code>Scope</code>，其实也就是 <code>configuration</code> 了：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project.configurations.create(<span class="string">'providedAar'</span>)</span><br></pre></td></tr></table></figure>
<p>当然，这都是一些 api 调用，没什么难度，我们只需要记住 <code>configuration</code> <code>Dependency Scope</code> 这些概念就可以了。</p>
<h3 id="加载缓存"><a href="#加载缓存" class="headerlink" title="加载缓存"></a>加载缓存</h3><p>Android 编译用到的缓存从以下几个地方去取：</p>
<ol>
<li><code>mavenLocal</code> 和 <code>gradle.user.home</code>（不要问我怎么知道的，看源码吧）；</li>
<li>在 Android 项目里，还会有一个 SDK 目录下的仓库路径；</li>
<li>旧版本的 Gradle Plugin 会从 <code>$buildDir/intermediates/exploded-aar</code> （这是个临时路径，每次 clean 都会被清空）去读取，新版本会从 <code>$HOME/.android/build-cache</code> （这不是临时路径，执行 clean 不会被清空）读取，当然，这个是有开关，可以选择是否开启的；</li>
</ol>
<p><code>mavenLocal</code> 里的依赖的父目录路径大致是这样的：<code>~/.m2/repository/com/google/code/gson/gson/2.7</code>，这路径下面就是具体的 <code>jar</code> <code>aar</code> <code>pom</code> 等文件。根据这些现象，我们再去看源码，就很容易会发现 <code>mavenLocal</code> 里的依赖父目录路径遵循以下规律（<code>mavenLocal</code> 路径，与依赖的 <code>groupId</code> <code>artifactId</code> <code>version</code> 拼接而成）：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project.repositories.mavenLocal().url.toString() - <span class="string">'file:'</span> + group.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">'/'</span> + name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">'/'</span> + version <span class="comment">// name  对应的就是依赖的 artifactId</span></span><br></pre></td></tr></table></figure>
<p>同理，<code>gradle.user.home</code> 下的依赖父目录路径大致是这样：<code>~/.gradle/caches/modules-2/files-2.1/com.google.gson/gson/2.6.2/</code>，这里要注意，gradle 缓存的 <code>jar</code> <code>aar</code> 和 <code>pom</code> 文件不是在同一个目录的，目录树结构如下图：</p>
<p><img src="http://7x2wvb.com1.z0.glb.clouddn.com/20171112-111644@2x.png" alt=""></p>
<p>获取 Gradle Cache 路径的代码如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> String getGradleCachePath() &#123;</span><br><span class="line">    <span class="keyword">def</span> defaultGradleUserHome = <span class="keyword">new</span> File(<span class="string">"$&#123;SystemProperties.instance.userHome&#125;/.gradle"</span>)</span><br><span class="line">    <span class="keyword">def</span> gradleUserHome = System.getProperty(<span class="string">'gradle.user.home'</span>)</span><br><span class="line">    <span class="keyword">if</span> (gradleUserHome == <span class="literal">null</span>) &#123;</span><br><span class="line">        gradleUserHome = System.getenv(<span class="string">"GRADLE_USER_HOME"</span>)</span><br><span class="line">        <span class="keyword">if</span> (gradleUserHome == <span class="literal">null</span>) &#123;</span><br><span class="line">            gradleUserHome = defaultGradleUserHome.absolutePath</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">"$&#123;gradleUserHome&#125;/caches/modules-2/files-2.1/"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再加上依赖的 <code>groupId</code> <code>artifactId</code> <code>version</code> 就可以确定此依赖的父目录路径，跟 <code>mavenLocal</code> 不同的是，它的的 <code>groupId</code> 本身就是个目录，而无需使用 “/“ 替换 “.”：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getGradleCachePath() + group + <span class="string">'/'</span> + name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">'/'</span> + version <span class="comment">// name  对应的就是依赖的 artifactId</span></span><br></pre></td></tr></table></figure>
<p>不过实际上不管是哪种缓存，我们只要拿到它的父目录，就可以遍历父目录，然后拿到这个具体的依赖，然后加载这个依赖缓存。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> File getAar(String aarParentPath) &#123;</span><br><span class="line">    <span class="keyword">def</span> aar = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">def</span> file = <span class="keyword">new</span> File(aarParentPath)</span><br><span class="line">    <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">        <span class="keyword">return</span> aar</span><br><span class="line">    &#125;</span><br><span class="line">    file.eachFileRecurse &#123;</span><br><span class="line">        <span class="keyword">if</span> (it.isFile() &amp;&amp; it.absolutePath.endsWith(<span class="string">'.aar'</span>)) &#123;</span><br><span class="line">            aar = it</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> aar</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="下载依赖"><a href="#下载依赖" class="headerlink" title="下载依赖"></a>下载依赖</h3><p>在 Gradle 里下载依赖有多种方式，而且代码实现都极其简单：</p>
<ol>
<li><p>直接获取要下载的依赖的 url，然后下载，这样整个逻辑就都要自己处理了；</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> repoUrls = <span class="keyword">new</span> HashSet()</span><br><span class="line">repoUrls.add(project.repositories.jcenter().url.toString())</span><br><span class="line">repoUrls.add(project.repositories.mavenCentral().url.toString())</span><br><span class="line"><span class="comment">//      repoUrls.add(project.repositories.google().url.toString())  gradle plugin 3.0 版本之后要加此仓库</span></span><br><span class="line">project.repositories.each &#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 不处理 FlatDirectoryArtifactRepository 和 IvyArtifactRepository</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!(it <span class="keyword">instanceof</span> DefaultMavenLocalArtifactRepository) &amp;&amp; (it <span class="keyword">instanceof</span> MavenArtifactRepository)) &#123;</span><br><span class="line">        repoUrls.add(it.url)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> String getDependencyByDownload(Project project, String dependency, HashSet&lt;String&gt; repoUrls, String mavenLocalDepPath) &#123;</span><br><span class="line">    <span class="keyword">def</span> aarPath = <span class="string">''</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">def</span> providedAarParent = <span class="keyword">new</span> File(mavenLocalDepPath)</span><br><span class="line">        <span class="keyword">if</span> (!providedAarParent.exists()) &#123;</span><br><span class="line">            providedAarParent.mkdirs()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">def</span> split = dependency.split(<span class="string">':'</span>)</span><br><span class="line">        <span class="keyword">def</span> depPath = split[<span class="number">0</span>].replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">'/'</span> + split[<span class="number">1</span>].replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">'/'</span> + split[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">def</span> depName = split[<span class="number">1</span>] + <span class="string">'-'</span> + split[<span class="number">2</span>] + <span class="string">'.aar'</span></span><br><span class="line">        <span class="keyword">def</span> depFile = <span class="keyword">new</span> File(providedAarParent, depName)</span><br><span class="line">        <span class="keyword">if</span> (depFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">return</span> depFile.absolutePath</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (String <span class="string">url :</span> repoUrls) &#123;</span><br><span class="line">            <span class="keyword">def</span> repoDepUrl = url.toString() + depPath + <span class="string">'/'</span> + depName</span><br><span class="line">            <span class="keyword">if</span> (!repoDepUrl.startsWith(<span class="string">'file:'</span>)) &#123;</span><br><span class="line">                project.logger.info <span class="string">'repoDepUrl : '</span> + repoDepUrl</span><br><span class="line">                FileUtils.copyURLToFile(<span class="keyword">new</span> URL(repoDepUrl), depFile)</span><br><span class="line">                aarPath = <span class="string">"$&#123;providedAarParent.absolutePath&#125;/$&#123;depName&#125;"</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        project.logger.error e.toString()</span><br><span class="line">        aarPath = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> aarPath</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>detachedConfiguration</code> ，这可能是最常用最正规的方式了（atlas 里是这么做的）；</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> String getDependencyByDownload(Project project, String dependency) &#123;</span><br><span class="line">    <span class="keyword">def</span> configuration = project.configurations.detachedConfiguration(project.dependencies.create(dependency))</span><br><span class="line">    configuration.setTransitive(<span class="literal">false</span>)</span><br><span class="line">    configuration.singleFile.absolutePath</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义 <code>Dependency Scope</code>，使其继承（<code>extendsFrom</code>） <code>Gradle</code> 提供的已有的 <code>Dependency Scope</code>，这是最投机取巧也最省时省力的方式（apt 就是这么做的）；</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project.configurations.create(<span class="string">'providedAar'</span>).extendsFrom(project.configurations.getByName(<span class="string">'provided'</span>))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>那么，我们这里下载依赖应该选取哪种方式呢？答案是只能是<strong>第一种</strong>方式。那么问题来了，这是为什么呢？这个问题的答案也是下面一节要讲述的的内容。</p>
<h3 id="生命周期之解决依赖关系"><a href="#生命周期之解决依赖关系" class="headerlink" title="生命周期之解决依赖关系"></a>生命周期之解决依赖关系</h3><p>Gradle 整个构建过程，生命周期分为三个阶段：<code>Initiliazatin</code> <code>Configuration</code> <code>Execution</code>，而 <code>resolveDependencies</code> 之前，调用 <code>detachedConfiguration</code> 是没有用的，而我们要去 hook 的是<code>resolveDependencies</code> 这个过程，显然 <code>detachedConfiguration</code> 这种方式就不合适了。</p>
<p>而第三种方式，老实讲，我不知道为什么不行，按照我的有限理解，应该是可以的，但是我试了之后，确实不可以，这个问题留待以后再看吧。</p>
<p>所以我们直接使用第一种方式是不是就可以正常下载了呢？其实也不是。还是考虑到生命周期的问题，我们必须要去 hook <code>resolveDependencies</code> 这个过程，不是我们经常看到的 <code>afterEvaluate</code> 或者 <code>beforeEvaluate</code>，因此，我们只能通过给 gradle 添加监听去实现，而且在 hook 之后，要手动 remove 这个监听。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">project.gradle.addListener(<span class="keyword">new</span> DependencyResolutionListener() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="typename">void</span> beforeResolve(ResolvableDependencies dependencies) &#123;</span><br><span class="line">        project.configurations.getByName(<span class="string">'providedAar'</span>).dependencies.each &#123;</span><br><span class="line">            <span class="keyword">def</span> group = it.group</span><br><span class="line">            <span class="keyword">def</span> name = it.name</span><br><span class="line">            <span class="keyword">def</span> version = it.version</span><br><span class="line">            <span class="keyword">def</span> dependency = <span class="string">"$&#123;it.group&#125;:$&#123;name&#125;:$&#123;version&#125;"</span></span><br><span class="line">            project.logger.info <span class="string">'dependency : '</span> + dependency</span><br><span class="line">        &#125;</span><br><span class="line">        project.gradle.removeListener(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="typename">void</span> afterResolve(ResolvableDependencies dependencies) &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="从-Aar-里获取-Jar"><a href="#从-Aar-里获取-Jar" class="headerlink" title="从 Aar 里获取 Jar"></a>从 Aar 里获取 Jar</h3><p>这一步就比较简单了，就是从 zip 包里读取一个 entry，然后输入输出流转成文件存储即可。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="typename">void</span> getJarFromAar(Project project, File aar) &#123;</span><br><span class="line">    <span class="keyword">def</span> aarName = aar.name</span><br><span class="line">    <span class="keyword">def</span> zipFile = <span class="keyword">new</span> ZipFile(aar)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">def</span> entries = zipFile.entries()</span><br><span class="line">        <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">            <span class="keyword">def</span> element = entries.nextElement()</span><br><span class="line">            project.logger.info element.name</span><br><span class="line">            <span class="keyword">if</span> (element.name == <span class="string">'classes.jar'</span>) &#123;</span><br><span class="line">                InputStream inputStream = zipFile.getInputStream(element)</span><br><span class="line">                <span class="keyword">def</span> file = <span class="keyword">new</span> File(aar.parent, aarName - <span class="string">'.aar'</span> + <span class="string">'.jar'</span>)</span><br><span class="line">                project.logger.info file.absolutePath</span><br><span class="line">                OutputStream outputStream = <span class="keyword">new</span> FileOutputStream(file)</span><br><span class="line">                IOUtils.copy(inputStream, outputStream)</span><br><span class="line">                outputStream.close()</span><br><span class="line">                inputStream.close()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        project.logger.error e.toString()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        zipFile.close()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>最后，还有两个我个人的实践经验：</p>
<ol>
<li>从 remote repository 里下载 aar 的存放路径，我是存放在了 <code>mavenLocal()</code> 里，这是最简单的方式，因为它的匹配规则最简单；</li>
<li>我在解出来 jar 之后，直接把 jar 放在了 aar 所在的路径，一是因为这是永久缓存，除非你手动删除它，二同样是因为这样最简单。</li>
</ol>
<p>这就是整个过程了。</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag">#Android</a>
          
            <a href="/tags/Gradle/" rel="tag">#Gradle</a>
          
            <a href="/tags/aar/" rel="tag">#aar</a>
          
            <a href="/tags/provided/" rel="tag">#provided</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/05/" rel="next" title="不要盲目拒绝计划之外的代码调试">
                <i class="fa fa-chevron-left"></i> 不要盲目拒绝计划之外的代码调试
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/01/" rel="prev" title="使用 repo 组织 Android 工程">
                使用 repo 组织 Android 工程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Ailurus" />
          <p class="site-author-name" itemprop="name">Ailurus</p>
          <p class="site-description motion-element" itemprop="description">Android Developer</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">145</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">215</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/liangzhitao" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/liangzhitao" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://facebook.com/liangzhitao" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/208087666" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://dim.red" title="明哥" target="_blank">明哥</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://veaer.com" title="veaer" target="_blank">veaer</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://yifeiyuan.me" title="程序亦非猿" target="_blank">程序亦非猿</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://abner-nimengbo.cn" title="阿布" target="_blank">阿布</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://fucknmb.com" title="区长" target="_blank">区长</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://kaedea.com" title="卡老师" target="_blank">卡老师</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#需要解决的问题"><span class="nav-number">1.</span> <span class="nav-text">需要解决的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义-Android-Dependency-Scope"><span class="nav-number">2.</span> <span class="nav-text">自定义 Android Dependency Scope</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载缓存"><span class="nav-number">3.</span> <span class="nav-text">加载缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载依赖"><span class="nav-number">4.</span> <span class="nav-text">下载依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生命周期之解决依赖关系"><span class="nav-number">5.</span> <span class="nav-text">生命周期之解决依赖关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从-Aar-里获取-Jar"><span class="nav-number">6.</span> <span class="nav-text">从 Aar 里获取 Jar</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ailurus</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'easydonecn';
      var disqus_identifier = '2017/11/07/';
      var disqus_title = '在 Android Application 里 provided aar';
      var disqus_url = 'http://liangzhitao.github.io/2017/11/07/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  

  

  

</body>
</html>
